<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نموذج تسجيل مورد جديد</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #2c3e50;
            line-height: 1.55;
            font-size: 16px;
        }
        .container {
            max-width: 790px;
            margin: 20px auto;
            background-color: #ffffff;
            padding: 25px 30px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.07);
            border: 1px solid #c5cdd4;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #0062cc;
        }
        header h1 {
            color: #004085;
            font-size: 28px;
            font-weight: 700;
            margin: 0;
        }
        .supplier-code-container {
            display: flex;
            align-items: center;
            background-color: #e2e6ea;
            padding: 8px 12px;
            border-radius: 6px;
        }
        .supplier-code-container label {
            margin-left: 10px;
            font-weight: 600;
            color: #343a40;
            font-size: 0.95em;
        }
        .supplier-code-container input[type="text"] {
            border: 1px solid #b0bac5;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 0.95em;
            line-height: 1.2;
            height: auto;
            min-height: 30px;
            width: 150px;
            background-color: #fff;
            text-align: center;
            font-weight: 600;
        }
        fieldset {
            border: 2px solid #aab8c5;
            border-radius: 8px;
            padding: 18px 25px;
            margin-bottom: 18px;
            background-color: #f8f9fa;
        }
        legend {
            font-size: 1.3em;
            font-weight: 700;
            color: #0056b3;
            padding: 0 12px;
            margin-right: 10px;
            background-color: #fff;
        }
        .form-group { margin-bottom: 15px; }
        .form-row { display: flex; gap: 20px; align-items: flex-start; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        fieldset > .form-row { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 7px;
            font-weight: 600;
            color: #3e4d5c;
            font-size: 1.0em;
        }
        .form-group label .required { color: #c82333; margin-left: 4px; font-weight: 700; }
        input[type="text"], input[type="number"], input[type="tel"], input[type="email"], select, input[type="date"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #b0bac5;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1.0em;
            line-height: 1.3;
            height: auto;
            min-height: 38px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #fff;
        }
        input[type="text"], input[type="number"], input[type="tel"], input[type="date"] {
            text-align: center;
            font-weight: 600;
        }
        input[type="email"] { text-align: left; font-weight: 400; }
        input[type="date"]:not([value]):not(:focus)::-webkit-datetime-edit-year-field,
        input[type="date"]:not([value]):not(:focus)::-webkit-datetime-edit-month-field,
        input[type="date"]:not([value]):not(:focus)::-webkit-datetime-edit-day-field,
        input[type="date"]:not([value]):not(:focus)::-webkit-datetime-edit-text {
            color: transparent !important;
        }
        input[type="date"]::before{
            content: 'DD-MM-YYYY';
            display: block;
            color: #99aabb;
            text-align: center;
            width: 100%;
        }
        input[type="date"][value]:not([value=""])::before { display: none; }
        input:focus, select:focus {
            border-color: #0056b3;
            box-shadow: 0 0 0 0.2rem rgba(0, 98, 204, 0.25);
            outline: none;
        }
        input::placeholder { color: #778899; font-size: 0.95em; text-align: right; font-weight: 400; }
        input[type="text"]::placeholder, input[type="number"]::placeholder, input[type="tel"]::placeholder {
            text-align: center;
        }
        .form-actions {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        button {
            background-color: #0062cc;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: background-color 0.2s ease;
            margin: 5px 8px;
        }
        button[type="button"] { background-color: #5a6268; }
        button:hover { background-color: #004a99; }
        button[type="button"]:hover { background-color: #474c52; }
        #formStatus {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
        }
        #formStatus.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #formStatus.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .error-message { color: #c82333; font-size: 0.85em; display: block; margin-top: 4px; }
        @media (max-width: 768px) {
            .form-row { flex-direction: column; gap: 0; }
            .form-row .form-group { margin-bottom: 15px; }
            header { flex-direction: column; align-items: flex-start; }
            header h1 { margin-bottom: 10px; }
            .supplier-code-container { width: 100%; justify-content: space-between; }
            .supplier-code-container input[type="text"] { flex-grow: 1; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>نموذج تسجيل مورد جديد</h1>
            <div class="supplier-code-container">
                <label for="supplierCode">كود المورد:</label>
                <input type="text" id="supplierCode" name="supplierCodeInput">
            </div>
        </header>

        <form id="supplierForm">
            <fieldset>
                <legend>البيانات الأساسية</legend>
                <div class="form-group">
                    <label for="supplierName">اسم المورد <span class="required">*</span></label>
                    <input type="text" id="supplierName" name="SupplierName" required placeholder="ادخل اسم المورد كاملاً">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="commercialReg">السجل التجاري <span class="required">*</span></label>
                        <input type="text" id="commercialReg" name="CommercialReg" required placeholder="رقم السجل التجاري">
                    </div>
                    <div class="form-group">
                        <label for="taxRegNum">رقم التسجيل الضريبي <span class="required">*</span></label>
                        <input type="text" id="taxRegNum" name="TaxRegNum" required
                               pattern="\d{3}-\d{3}-\d{3}"
                               title="الرجاء إدخال 9 أرقام مفصولة بشرطات (123-456-789)"
                               placeholder="XXX-XXX-XXX">
                    </div>
                </div>
                <div class="form-group">
                    <label for="taxStatus">الحالة الضريبية <span class="required">*</span></label>
                    <select id="taxStatus" name="TaxStatus" required>
                        <option value="">اختر الحالة...</option>
                        <option value="خاضع للضريبة">خاضع للضريبة</option>
                        <option value="معفي من الضريبة">معفي من الضريبة</option>
                        <option value="غير مسجل">غير مسجل</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>البيانات المالية</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceDiscount">خصم الفاتورة (%)</label>
                        <input type="number" id="invoiceDiscount" name="InvoiceDiscount" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="deferredDiscount">خصم مؤجل (%)</label>
                        <input type="number" id="deferredDiscount" name="DeferredDiscount" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="codingFees">رسوم تكويد</label>
                        <input type="number" id="codingFees" name="CodingFees" min="0" step="0.01" placeholder="بالعملة المحلية">
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">طريقة السداد <span class="required">*</span></label>
                        <select id="paymentMethod" name="PaymentMethod" required>
                            <option value="">اختر طريقة...</option>
                            <option value="نقدي">نقدي</option>
                            <option value="تحويل بنكي">تحويل بنكي</option>
                            <option value="شيك">شيك</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentPeriod">فترة السداد (أيام)</label>
                        <input type="number" id="paymentPeriod" name="PaymentPeriod" min="0">
                    </div>
                    <div class="form-group">
                        <label for="returnPeriod">فترة رفع المرتجع (أيام)</label>
                        <input type="number" id="returnPeriod" name="ReturnPeriod" min="0">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>بيانات الاتصال</legend>
                <div class="form-group">
                    <label for="contactPerson">اسم المسؤول <span class="required">*</span></label>
                    <input type="text" id="contactPerson" name="ContactPerson" required placeholder="اسم مسؤول الاتصال">
                </div>
                <div class="form-group">
                    <label for="jobTitle">المسمى الوظيفي</label>
                    <input type="text" id="jobTitle" name="JobTitle">
                </div>
                <div class="form-group">
                    <label for="phoneNumber">رقم التليفون <span class="required">*</span></label>
                    <input type="tel" id="phoneNumber" name="PhoneNumber" pattern="[0-9\s\-\+\(\)]+" required placeholder="مثال: +201XXXXXXXXX">
                </div>
                <div class="form-group">
                    <label for="email">البريد الإلكتروني <span class="required">*</span></label>
                    <input type="email" id="email" name="Email" required placeholder="example@domain.com">
                </div>
            </fieldset>

            <fieldset>
                <legend>بيانات أخرى</legend>
                <div class="form-group">
                    <label for="requesterName">صاحب الطلب</label>
                    <input type="text" id="requesterName" name="RequesterName" placeholder="اسم مقدم الطلب">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="requestDate">تاريخ الطلب</label>
                        <input type="date" id="requestDate" name="RequestDate">
                    </div>
                    <div class="form-group">
                        <label for="registrationDate">تاريخ التسجيل</label>
                        <input type="date" id="registrationDate" name="RegistrationDate">
                    </div>
                </div>
            </fieldset>

            <div class="form-actions">
                <button type="submit" id="submitBtn">تسجيل المورد</button>
                <button type="button" id="exportPdfBtn">تصدير كـ PDF</button>
                <button type="button" id="checkConnectionBtn">التحقق من الاتصال</button>
            </div>
        </form>
        <div id="formStatus"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('supplierForm');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const checkConnectionBtn = document.getElementById('checkConnectionBtn');
        const formStatusDiv = document.getElementById('formStatus');
        const supplierCodeInputField = document.getElementById('supplierCode');

        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyyV_FTG1ucBGVDVlfq8sV0eNT1oodGwXRS23HVFYwSTihLyn7BvNSxybmDkhvym9P_/exec';

        function isGoogleScriptUrlSet() {
            const placeholderOriginal = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL'; // Original placeholder string
            const placeholderExamplePart = 'AKfycbxUlmPyoUxMdfOG1kvo-iWCQ2BfQKo_wbR76pOFey8xAErgLf51b2XirOivcMoVIeHdkA'; // An old example placeholder segment

            if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL === placeholderOriginal || GOOGLE_SCRIPT_URL.includes(placeholderExamplePart)) {
                formStatusDiv.textContent = 'خطأ: لم يتم تكوين عنوان URL الخاص بـ Google Apps Script بشكل صحيح. يرجى تحديثه في الكود بالقيمة الصحيحة.';
                formStatusDiv.className = 'error';
                console.error('Google Apps Script URL is not set or is still a placeholder.');
                return false;
            }
            return true;
        }

        function clearErrorMessages() {
            form.querySelectorAll('.error-message').forEach(msg => msg.remove());
            form.querySelectorAll('[style*="border-color: rgb(200, 35, 51)"]').forEach(input => input.style.borderColor = '#b0bac5');
        }

        function validateForm() {
            let isValid = true;
            clearErrorMessages();
            formStatusDiv.innerHTML = '';
            formStatusDiv.className = '';

            form.querySelectorAll('[required]').forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.style.borderColor = '#c82333';
                    const errorMsg = document.createElement('small');
                    errorMsg.textContent = 'هذا الحقل مطلوب';
                    errorMsg.classList.add('error-message');
                    field.parentNode.insertBefore(errorMsg, field.nextSibling);
                } else {
                    field.style.borderColor = '#b0bac5';
                }
            });

            const taxRegNumInput = document.getElementById('taxRegNum');
            if (taxRegNumInput.value.trim() && !taxRegNumInput.checkValidity()) {
                isValid = false;
                taxRegNumInput.style.borderColor = '#c82333';
                const errorMsg = document.createElement('small');
                errorMsg.textContent = taxRegNumInput.title || 'تنسيق غير صحيح.';
                errorMsg.classList.add('error-message');
                if (!taxRegNumInput.nextElementSibling || !taxRegNumInput.nextElementSibling.classList.contains('error-message')) {
                    taxRegNumInput.parentNode.insertBefore(errorMsg, taxRegNumInput.nextSibling);
                }
            } else if (taxRegNumInput.value.trim() && taxRegNumInput.checkValidity()){
                 taxRegNumInput.style.borderColor = '#b0bac5';
            }

            if (!isValid) {
                formStatusDiv.textContent = 'الرجاء ملء جميع الحقول المطلوبة بشكل صحيح.';
                formStatusDiv.className = 'error';
            }
            return isValid;
        }

        checkConnectionBtn.addEventListener('click', async function() {
            if (!isGoogleScriptUrlSet()) return;

            formStatusDiv.textContent = 'جاري التحقق من الاتصال بقاعدة البيانات...';
            formStatusDiv.className = '';
            checkConnectionBtn.disabled = true;

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=checkConnection`, { method: 'GET' });
                if (!response.ok) {
                    let errorText = `فشل الاتصال بالخادم: ${response.status}`;
                    try {
                        const errData = await response.json();
                        errorText = errData.message || errData.error?.message || errorText;
                    } catch (e) { errorText = `${errorText} (${response.statusText})`; }
                    throw new Error(errorText);
                }
                const data = await response.json();
                if (data.status === 'success') {
                    formStatusDiv.textContent = data.message || 'تم الاتصال بقاعدة البيانات بنجاح.';
                    formStatusDiv.className = 'success';
                } else {
                    formStatusDiv.textContent = data.message || 'فشل الاتصال أو تهيئة قاعدة البيانات.';
                    formStatusDiv.className = 'error';
                }
            } catch (error) {
                console.error('Connection check error:', error);
                formStatusDiv.textContent = 'خطأ أثناء التحقق من الاتصال: ' + error.message;
                formStatusDiv.className = 'error';
            } finally {
                checkConnectionBtn.disabled = false;
            }
        });

        form.addEventListener('submit', function (event) {
            event.preventDefault();
            if (!validateForm() || !isGoogleScriptUrlSet()) return;

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'جاري الإرسال...';
            formStatusDiv.textContent = 'جاري حفظ البيانات...';
            formStatusDiv.className = '';

            const formData = new FormData(form);
            formData.append('SupplierCode', supplierCodeInputField.value);

            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => {
                if (!response.ok) {
                    return response.json().catch(() => {
                        throw new Error(`خطأ من الخادم: ${response.status} ${response.statusText}`);
                    }).then(errorData => {
                        throw new Error(errorData.message || errorData.error?.message || `خطأ من الخادم: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    formStatusDiv.textContent = data.message || 'تم حفظ بيانات المورد بنجاح.';
                    formStatusDiv.className = 'success';
                    form.reset();
                    supplierCodeInputField.value = '';
                    clearErrorMessages();
                } else {
                    throw new Error(data.message || 'فشل حفظ البيانات من جهة الخادم.');
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                formStatusDiv.textContent = 'فشل إرسال البيانات. الخطأ: ' + error.message;
                formStatusDiv.className = 'error';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'تسجيل المورد';
            });
        });

        exportPdfBtn.addEventListener('click', function () {
            formStatusDiv.innerHTML = '';
            formStatusDiv.className = '';
            console.log("Attempting PDF export...");

            let supplierNameValue = document.getElementById('supplierName').value.trim() || "بيانات_مورد";
            const fileName = `نموذج_مورد_${supplierNameValue.replace(/\s+/g, '_')}.pdf`;

            const { jsPDF } = window.jspdf;
            const formToExport = document.querySelector('.container');

            const buttons = formToExport.querySelectorAll('.form-actions button');
            buttons.forEach(btn => btn.style.display = 'none');
            const formStatusElement = formToExport.querySelector('#formStatus');
            if (formStatusElement) formStatusElement.style.display = 'none';

            const pdfTitleElement = document.createElement('h2');
            const supplierCodeVal = supplierCodeInputField.value.trim();
            const supplierNameVal = document.getElementById('supplierName').value.trim();

            let titleText = "بيانات مورد جديد";
            if (supplierNameVal) titleText = `بيانات المورد: ${supplierNameVal}`;
            if (supplierCodeVal) titleText += ` (كود: ${supplierCodeVal})`;
            if (!supplierNameVal && !supplierCodeVal) titleText = "بيانات مورد (للملء)";

            pdfTitleElement.textContent = titleText;
            pdfTitleElement.style.cssText = "text-align: center; color: #004085; margin-bottom: 20px; font-size: 22px; font-family: 'Cairo', sans-serif;";
            formToExport.insertBefore(pdfTitleElement, form);

            const originalValues = {};
            const fieldsToBlankInPdf = ['supplierCode', 'requestDate', 'registrationDate'];

            fieldsToBlankInPdf.forEach(id => {
                const input = document.getElementById(id);
                if (input) originalValues[id] = input.value;
            });

            console.log("Starting html2canvas...");
            try {
                html2canvas(formToExport, {
                    scale: 1.8, useCORS: true, logging: true, allowTaint: true,
                    removeContainer: false, imageTimeout: 0,
                    onclone: (documentClone, element) => {
                        console.log("html2canvas onclone started.");
                        try {
                            documentClone.documentElement.setAttribute('dir', 'rtl');
                            if (documentClone.body) {
                                documentClone.body.style.fontFamily = "'Cairo', sans-serif";
                                documentClone.body.style.fontSize = "16px";
                            }
                            documentClone.querySelector('.container')?.style.setProperty('direction', 'rtl', 'important');


                            const originalInputs = element.querySelectorAll('input, select, textarea');
                            const clonedInputs = documentClone.querySelectorAll('input, select, textarea');

                            originalInputs.forEach((originalInput, index) => {
                                if (clonedInputs[index]) {
                                    const clonedEl = clonedInputs[index];
                                    const computedStyle = getComputedStyle(originalInput);
                                    let textToRender = originalInput.value;
                                    const isBlankableField = fieldsToBlankInPdf.includes(originalInput.id);

                                    if (isBlankableField) {
                                        textToRender = "";
                                        if (originalInput.type === 'date') clonedEl.removeAttribute('value');
                                    } else if (originalInput.tagName === 'SELECT') {
                                        const selIdx = originalInput.selectedIndex;
                                        textToRender = (selIdx > -1 && originalInput.options[selIdx]?.value !== "") ? originalInput.options[selIdx].text : ".......................";
                                        clonedEl.style.appearance = 'none';
                                        clonedEl.style.backgroundImage = 'none';
                                    } else if (!textToRender && (originalInput.tagName === 'INPUT' || originalInput.tagName === 'TEXTAREA') && !isBlankableField) {
                                        textToRender = ".......................";
                                    }
                                    
                                    clonedEl.value = textToRender;
                                    clonedEl.style.fontFamily = "'Cairo', sans-serif";
                                    clonedEl.style.fontSize = computedStyle.fontSize;
                                    clonedEl.style.fontWeight = computedStyle.fontWeight;
                                    clonedEl.style.color = computedStyle.color;
                                    clonedEl.style.backgroundColor = "#ffffff";
                                    clonedEl.style.border = "1px solid #777";
                                    clonedEl.style.borderRadius = computedStyle.borderRadius;
                                    clonedEl.style.boxSizing = 'border-box';
                                    clonedEl.style.margin = '0';
                                    clonedEl.style.minHeight = computedStyle.minHeight;
                                    clonedEl.style.height = computedStyle.height === 'auto' ? clonedEl.style.minHeight : computedStyle.height;
                                    clonedEl.style.display = 'flex';
                                    clonedEl.style.alignItems = 'center';

                                    if (['text', 'number', 'tel', 'date'].includes(originalInput.type) || originalInput.id === 'supplierCode') {
                                       clonedEl.style.justifyContent = 'center';
                                       clonedEl.style.textAlign = 'center';
                                       clonedEl.style.padding = `0`;
                                    } else if (originalInput.type === 'email'){
                                       clonedEl.style.justifyContent = 'flex-start';
                                       clonedEl.style.textAlign = 'left';
                                       clonedEl.style.padding = `0 ${computedStyle.paddingRight || '12px'} 0 ${computedStyle.paddingLeft || '12px'}`;
                                    } else {
                                       clonedEl.style.justifyContent = 'flex-start';
                                       clonedEl.style.textAlign = 'right';
                                       clonedEl.style.padding = `0 ${computedStyle.paddingRight || '12px'} 0 ${computedStyle.paddingLeft || '12px'}`;
                                    }
                                    if (originalInput.type === 'checkbox' || originalInput.type === 'radio') {
                                        clonedEl.style.display = '';
                                        clonedEl.checked = originalInput.checked;
                                    }
                                }
                            });
                            documentClone.querySelectorAll('legend').forEach(leg => {
                                leg.style.cssText = "background-color: #f8f9fa; border: 1px solid #aab8c5; padding: 2px 8px;";
                            });
                        } catch (cloneError) { console.error("Error during onclone:", cloneError); }
                        console.log("html2canvas onclone finished.");
                    }
                }).then(canvas => {
                    fieldsToBlankInPdf.forEach(id => {
                        const input = document.getElementById(id);
                        if (input && originalValues.hasOwnProperty(id)) input.value = originalValues[id];
                    });
                    buttons.forEach(btn => btn.style.display = '');
                    if (formStatusElement) formStatusElement.style.display = '';
                    pdfTitleElement?.remove();

                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', putOnlyUsedFonts: true, floatPrecision: 16 });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgProps = pdf.getImageProperties(imgData);
                    const pageMargin = 10;
                    const availableWidth = pdfWidth - (2 * pageMargin);
                    const availableHeight = pdfHeight - (2 * pageMargin);
                    const ratio = Math.min(availableWidth / imgProps.width, availableHeight / imgProps.height);
                    const finalImgWidth = imgProps.width * ratio;
                    const finalImgHeight = imgProps.height * ratio;
                    const xPos = (pdfWidth - finalImgWidth) / 2;
                    const yPos = (pdfHeight - finalImgHeight) / 2;

                    pdf.addImage(imgData, 'PNG', xPos, yPos, finalImgWidth, finalImgHeight);
                    pdf.save(fileName);
                    formStatusDiv.textContent = 'تم تصدير النموذج كملف PDF بنجاح.';
                    formStatusDiv.className = 'success';
                }).catch(err => {
                    fieldsToBlankInPdf.forEach(id => {
                        const input = document.getElementById(id);
                        if (input && originalValues.hasOwnProperty(id)) input.value = originalValues[id];
                    });
                    buttons.forEach(btn => btn.style.display = '');
                    if (formStatusElement) formStatusElement.style.display = '';
                    pdfTitleElement?.remove();
                    console.error("PDF Export Error (html2canvas):", err);
                    formStatusDiv.textContent = 'فشل تصدير PDF. خطأ: ' + (err.message || err);
                    formStatusDiv.className = 'error';
                });
            } catch (outerError) {
                fieldsToBlankInPdf.forEach(id => {
                    const input = document.getElementById(id);
                    if (input && originalValues.hasOwnProperty(id)) input.value = originalValues[id];
                });
                buttons.forEach(btn => btn.style.display = '');
                if (formStatusElement) formStatusElement.style.display = '';
                pdfTitleElement?.remove();
                console.error("PDF Export Outer Error:", outerError);
                formStatusDiv.textContent = 'فشل تصدير PDF. خطأ خارجي: ' + (outerError.message || outerError);
                formStatusDiv.className = 'error';
            }
        });
    });
    </script>
</body>
</html>
