<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الموردين</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23005a9c'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --white-bg: #ffffff;
            --text-dark: #212529;
            --text-light: #f8f9fa;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background-color: var(--light-bg);
            margin: 0;
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        .sidebar {
            background-color: var(--dark-bg);
            color: var(--text-light);
            padding: 25px;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 260px;
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header .logo {
            background-color: var(--primary-color);
            border-radius: var(--border-radius);
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-header h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }
        .sidebar-action {
            margin-top: auto;
        }
        .button.full-width {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            font-size: 1.1em;
        }

        /* --- Main Content --- */
        .main-content {
            grid-column: 2 / 3;
            padding: 30px;
            background-color: #f0f2f5;
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .search-bar {
            position: relative;
            flex-grow: 1;
        }
        .search-bar input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            font-size: 1.1em;
            transition: all 0.2s ease;
        }
        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        .search-bar .icon {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* --- Results Container & Cards --- */
        #resultsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }
        .supplier-card {
            background-color: var(--white-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .supplier-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .card-header h3 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary-dark);
        }
        .card-header .code {
            font-size: 0.9em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .card-body {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .card-info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-dark);
        }
        .card-info-item .icon { color: var(--text-muted); }
        .card-footer {
            padding: 15px 20px;
            background-color: var(--light-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        /* --- General UI Elements --- */
        .button {
            background-color: var(--primary-color); color: white; padding: 10px 20px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .button:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .button.secondary { background-color: var(--secondary-color); }
        .button.secondary:hover { background-color: #5a6268; }
        .button.danger { background-color: var(--danger-color); }
        .button.danger:hover { background-color: #c82333; }
        .button.warning { background-color: var(--warning-color); color: var(--text-dark); }
        .button.warning:hover { background-color: #e0a800; }
        .button.success { background-color: var(--success-color); }
        .button.success:hover { background-color: #218838; }

        .icon { width: 20px; height: 20px; }
        .button .icon { width: 18px; height: 18px; }

        #formStatus { margin: -15px 0 20px 0; text-align: center; }

        /* --- Loader & Messages --- */
        .loader-container, .message-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40vh; text-align: center; color: var(--text-muted); grid-column: 1 / -1; /* Span all columns */
        }
        .message-container .icon { width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.5; }
        .message-container h3 { font-size: 1.5em; color: var(--text-dark); margin: 0 0 10px 0; }
        .loader {
            border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid var(--primary-color); width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Modal Styles --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;
        }
        .modal.visible { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content {
            background-color: var(--white-bg); margin: auto; padding: 0; border: none; width: 90%; max-width: 850px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; overflow: hidden;
            transform: scale(0.95); opacity: 0; animation: popIn 0.3s ease forwards;
        }
        .modal.visible .modal-content { transform: scale(1); opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; border-bottom: 1px solid var(--border-color); background-color: var(--light-bg);
        }
        .modal-title { color: var(--primary-dark); margin: 0; font-size: 1.6em; font-weight: 700; }
        .close-button { color: var(--text-muted); font-size: 24px; font-weight: bold; background: none; border: none; cursor: pointer; transition: color 0.2s ease; }
        .close-button:hover { color: var(--danger-color); }
        .modal-body { padding: 30px; max-height: 70vh; overflow-y: auto; }
        .modal-footer {
            padding: 20px 30px; border-top: 1px solid var(--border-color); background-color: var(--light-bg); text-align: left;
        }
        
        /* Form-specific styling inside modal */
        fieldset { border: 1px solid #ddd; border-radius: var(--border-radius); padding: 18px 25px; margin-bottom: 25px; }
        legend { font-size: 1.2em; font-weight: 700; color: var(--text-dark); padding: 0 10px; margin-right: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-row .form-group { margin-bottom: 0; }
        input[type="text"], input[type="number"], input[type="tel"], input[type="email"], select, input[type="date"] {
             width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em;
        }
        input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2); outline: none; }
        #modalFormStatus { margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center; display: none; }
        .error-message { color: var(--danger-color); font-size: 0.85em; display: block; margin-top: 4px; }
        #modalFormStatus.success { background-color: #d4edda; color: #155724; }
        #modalFormStatus.error { background-color: #f8d7da; color: #721c24; }
        
        /* Detail Ticket Modal */
        #supplierDetailModal .detail-section { margin-bottom: 25px; }
        #supplierDetailModal .detail-section h3 { margin-bottom: 15px; font-size: 1.3em; color: var(--text-dark); padding-bottom: 8px; border-bottom: 2px solid var(--primary-color); }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 30px; }
        .detail-item { font-size: 1.05em; }
        .detail-item strong { display: block; color: var(--text-muted); font-weight: 600; margin-bottom: 4px; font-size: 0.9em; }
        .detail-item span { display: block; padding: 6px 10px; background-color: #f1f3f5; border-radius: 4px; min-height: 24px; word-wrap: break-word; font-weight: 600; }
        .detail-item span[dir="ltr"] { text-align: left; }

        /* --- Responsive Design --- */
        @media (max-width: 992px) {
            .app-shell { grid-template-columns: 1fr; }
            .sidebar {
                position: relative; width: 100%; height: auto; flex-direction: row; justify-content: space-between; align-items: center; border-radius: 0;
            }
            .sidebar-header { margin: 0; border: none; padding: 0; }
            .sidebar-action { margin: 0; }
            .main-content { grid-column: 1 / 2; padding: 20px; }
            #resultsContainer { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
            .modal-content { max-width: 95vw; }
        }
        @media (max-width: 768px) {
            .main-header { flex-direction: column; align-items: stretch; }
            .form-row { grid-template-columns: 1fr; }
        }
        
        /* --- Print Styles --- */
        @media print {
            body { background-color: var(--white-bg); }
            .app-shell, .modal-footer, .close-button { display: none; }
            .modal.visible { display: block; position: static; background: none; }
            .modal-content { box-shadow: none; border: 1px solid #ccc; max-width: 100%; border-radius: 0; }
            .modal-print-area { visibility: visible; }
            .modal-print-area * { visibility: visible; }
        }
    </style>
</head>
<body>

    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg class="icon" style="width: 28px; height: 28px; fill: white;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.5 12c1.38 0 2.5-1.12 2.5-2.5S17.88 7 16.5 7C15.12 7 14 8.12 14 9.5s1.12 2.5 2.5 2.5zM9 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm7.5 3c-1.83 0-5.5.92-5.5 2.75V19h11v-2.25c0-1.83-3.67-2.75-5.5-2.75zM9 13c-2.33 0-7 1.17-7 3.5V19h7v-2.25c0-.85.33-2.34 2.37-3.47C10.5 13.1 9.66 13 9 13z"/></svg>
                </div>
                <h1>إدارة الموردين</h1>
            </div>
            <div class="sidebar-action">
                <button id="addNewSupplierBtn" class="button success full-width">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    <span>إضافة مورد</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="ابحث عن مورد بالاسم، الكود، الهاتف...">
                     <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <button id="searchBtn" class="button">بحث</button>
            </header>
            
            <div id="formStatus"></div>

            <div id="resultsContainer">
                <!-- Initial message will be injected here -->
            </div>
        </main>
    </div>

    <!-- Modals (kept outside the main flow) -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">إضافة مورد جديد</h2>
                <button class="close-button" title="إغلاق">×</button>
            </div>
            <form id="supplierModalForm">
                <div class="modal-body">
                    <input type="hidden" id="modalRecordId" name="recordId">
                    <!-- Form content is the same as before -->
                    <fieldset>
                        <legend>البيانات الأساسية</legend>
                        <div class="form-group"><label for="modalSupplierCode">كود المورد:</label><input type="text" id="modalSupplierCode" name="SupplierCode" placeholder="اتركه فارغاً للتوليد التلقائي"></div>
                        <div class="form-group"><label for="modalSupplierName">اسم المورد <span class="required">*</span></label><input type="text" id="modalSupplierName" name="SupplierName" required></div>
                        <div class="form-row">
                            <div class="form-group"><label for="modalCommercialReg">السجل التجاري <span class="required">*</span></label><input type="text" id="modalCommercialReg" name="CommercialReg" required></div>
                            <div class="form-group"><label for="modalTaxRegNum">رقم التسجيل الضريبي <span class="required">*</span></label><input type="text" id="modalTaxRegNum" name="TaxRegNum" required></div>
                        </div>
                        <div class="form-group"><label for="modalTaxStatus">الحالة الضريبية <span class="required">*</span></label><select id="modalTaxStatus" name="TaxStatus" required><option value="خاضع">خاضع</option><option value="معفي">معفي</option></select></div>
                    </fieldset>
                    <fieldset><legend>البيانات المالية</legend><div class="form-row"><div class="form-group"><label for="modalInvoiceDiscount">خصم الفاتورة (%)</label><input type="number" id="modalInvoiceDiscount" name="InvoiceDiscount" min="0" step="0.01"></div><div class="form-group"><label for="modalDeferredDiscount">خصم مؤجل (%)</label><input type="number" id="modalDeferredDiscount" name="DeferredDiscount" min="0" step="0.01"></div></div><div class="form-row"><div class="form-group"><label for="modalCodingFees">رسوم تكويد</label><input type="number" id="modalCodingFees" name="CodingFees" min="0" step="0.01"></div><div class="form-group"><label for="modalPaymentMethod">طريقة السداد <span class="required">*</span></label><select id="modalPaymentMethod" name="PaymentMethod" required><option value="">اختر...</option><option value="نقدي">نقدي</option><option value="تحويل بنكي">تحويل بنكي</option><option value="شيك">شيك</option></select></div></div><div class="form-row"><div class="form-group"><label for="modalPaymentPeriod">فترة السداد (أيام)</label><input type="number" id="modalPaymentPeriod" name="PaymentPeriod" min="0"></div><div class="form-group"><label for="modalReturnPeriod">فترة رفع المرتجع (أيام)</label><input type="number" id="modalReturnPeriod" name="ReturnPeriod" min="0"></div></div></fieldset>
                    <fieldset><legend>بيانات الاتصال</legend><div class="form-group"><label for="modalContactPerson">اسم المسؤول <span class="required">*</span></label><input type="text" id="modalContactPerson" name="ContactPerson" required></div><div class="form-group"><label for="modalJobTitle">المسمى الوظيفي</label><input type="text" id="modalJobTitle" name="JobTitle"></div><div class="form-group"><label for="modalPhoneNumber">رقم التليفون <span class="required">*</span></label><input type="tel" id="modalPhoneNumber" name="PhoneNumber" required></div><div class="form-group"><label for="modalEmail">البريد الإلكتروني <span class="required">*</span></label><input type="email" id="modalEmail" name="Email" required></div></fieldset>
                    <fieldset><legend>بيانات أخرى</legend><div class="form-group"><label for="modalRequesterName">صاحب الطلب</label><input type="text" id="modalRequesterName" name="RequesterName"></div><div class="form-row"><div class="form-group"><label for="modalRequestDate">تاريخ الطلب</label><input type="date" id="modalRequestDate" name="RequestDate"></div><div class="form-group"><label for="modalRegistrationDate">تاريخ التسجيل</label><input type="date" id="modalRegistrationDate" name="RegistrationDate"></div></div></fieldset>
                    <div id="modalFormStatus"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" id="modalSubmitBtn" class="button success">حفظ</button>
                    <button type="button" class="button secondary modal-cancel-btn">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <div id="supplierDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-print-area">
                <div class="modal-header">
                    <h2 id="detailModalTitle" class="modal-title">تفاصيل المورد</h2>
                    <button class="close-button" title="إغلاق">×</button>
                </div>
                <div class="modal-body" id="detailContent">
                    <!-- Detail content will be populated by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="detailPrintBtn" class="button success">طباعة</button>
                <button id="detailEditBtn" class="button warning">تعديل</button>
                <button id="detailCloseBtn" class="button secondary">إغلاق</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- CONFIG & CONSTANTS ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyc0dz9vqkjei3Ipw2CCEUKLsBJS5gghETgtUvqm3PHED-daCDLKbox-yjMePYPQZpY/exec'; // IMPORTANT: Replace with your actual script URL
        const ICONS = {
            user: `<svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>`,
            phone: `<svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg>`,
            email: `<svg class="icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg>`,
            view: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`,
            delete: `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`,
            initial: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 10-4.773-4.773 3.375 3.375 0 004.774 4.774zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            empty: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>`
        };

        // --- DOM ELEMENTS ---
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const addNewSupplierBtn = document.getElementById('addNewSupplierBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const formStatusDiv = document.getElementById('formStatus');

        // Modals & Forms
        const supplierModal = document.getElementById('supplierModal');
        const detailModal = document.getElementById('supplierDetailModal');
        const supplierModalForm = document.getElementById('supplierModalForm');
        const modalRecordIdInput = document.getElementById('modalRecordId');
        const modalSubmitBtn = document.getElementById('modalSubmitBtn');
        const detailContent = document.getElementById('detailContent');
        const detailModalTitle = document.getElementById('detailModalTitle');

        // --- HELPER FUNCTIONS ---
        const escapeHTML = str => String(str ?? '').replace(/[&<>"']/g, m => ({ '&': '&', '<': '<', '>': '>', '"': '"', "'": ''' })[m]);
        const showStatus = (msg, type) => {
            formStatusDiv.innerHTML = msg;
            formStatusDiv.className = `alert alert-${type}`;
            formStatusDiv.style.display = msg ? 'block' : 'none';
        };

        const showMessage = (type, title, text) => {
            const icon = type === 'initial' ? ICONS.initial : ICONS.empty;
            resultsContainer.innerHTML = `
                <div class="message-container">
                    ${icon}
                    <h3>${title}</h3>
                    <p>${text}</p>
                </div>`;
        };
        
        const showLoading = (isLoading) => {
            if (isLoading) {
                resultsContainer.innerHTML = `<div class="loader-container"><div class="loader"></div></div>`;
            }
        };

        const toggleModal = (modal, show) => {
            if (show) modal.classList.add('visible');
            else modal.classList.remove('visible');
        };

        // --- DATA FETCHING & RENDERING ---
        async function fetchData(searchTerm = '') {
            if (!GOOGLE_SCRIPT_URL.includes('/macros/s/')) {
                showStatus('خطأ: رابط Google Script غير صحيح.', 'danger');
                return;
            }
            showLoading(true);

            const url = new URL(GOOGLE_SCRIPT_URL);
            url.searchParams.append('action', 'searchSuppliers');
            url.searchParams.append('term', searchTerm);
            
            try {
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success') {
                    if (result.data && result.data.length > 0) renderCards(result.data);
                    else showMessage('empty', 'لا توجد نتائج', 'لم يتم العثور على موردين يطابقون بحثك. حاول بكلمات أخرى.');
                } else {
                    throw new Error(result.message || 'فشل جلب البيانات.');
                }
            } catch (error) {
                console.error('Error during fetchData:', error);
                showMessage('empty', 'حدث خطأ', `فشل تحميل البيانات: ${error.message}`);
            }
        }

        function renderCards(data) {
            resultsContainer.innerHTML = '';
            data.forEach(record => {
                const card = document.createElement('div');
                card.className = 'supplier-card';
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${escapeHTML(record.SupplierName)}</h3>
                        <span class="code">الكود: ${escapeHTML(record.SupplierCode) || 'N/A'}</span>
                    </div>
                    <div class="card-body">
                        <div class="card-info-item">${ICONS.user}<span>${escapeHTML(record.ContactPerson)}</span></div>
                        <div class="card-info-item">${ICONS.phone}<span>${escapeHTML(record.PhoneNumber)}</span></div>
                        <div class="card-info-item">${ICONS.email}<span dir="ltr">${escapeHTML(record.Email)}</span></div>
                    </div>
                    <div class="card-footer">
                        <button class="button view-btn" data-id="${escapeHTML(record.RowID)}">${ICONS.view} عرض</button>
                        <button class="button danger delete-btn" data-id="${escapeHTML(record.RowID)}">${ICONS.delete} حذف</button>
                    </div>`;
                resultsContainer.appendChild(card);
            });
            addCardActionListeners();
        }

        function addCardActionListeners() {
            resultsContainer.querySelectorAll('.view-btn').forEach(b => b.addEventListener('click', (e) => showSupplierDetails(e.currentTarget.dataset.id)));
            resultsContainer.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', (e) => handleDeleteClick(e.currentTarget.dataset.id)));
        }

        // --- DETAIL "TICKET" MODAL LOGIC ---
        async function showSupplierDetails(recordId) {
            if (!recordId) return;
            const url = new URL(GOOGLE_SCRIPT_URL);
            url.searchParams.append('action', 'getSupplierById');
            url.searchParams.append('id', recordId);
            
            try {
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success' && result.data) {
                    populateDetailModal(result.data);
                    detailModal.dataset.recordId = recordId;
                    toggleModal(detailModal, true);
                } else { throw new Error(result.message); }
            } catch (error) { showMessage('empty', 'خطأ', error.message); }
        }

        function populateDetailModal(record) {
            const format = (val, isDate = false) => {
                if(isDate && val) return escapeHTML(val.split('T')[0]);
                return escapeHTML(val) || '<span style="color:var(--text-muted)">--</span>';
            };
            detailModalTitle.textContent = `تفاصيل: ${escapeHTML(record.SupplierName)}`;
            detailContent.innerHTML = `
                <div class="detail-section"><h3>البيانات الأساسية</h3><div class="detail-grid">
                    <div class="detail-item"><strong>كود المورد:</strong><span>${format(record.SupplierCode)}</span></div>
                    <div class="detail-item"><strong>اسم المورد:</strong><span>${format(record.SupplierName)}</span></div>
                    <div class="detail-item"><strong>السجل التجاري:</strong><span>${format(record.CommercialReg)}</span></div>
                    <div class="detail-item"><strong>رقم التسجيل الضريبي:</strong><span>${format(record.TaxRegNum)}</span></div>
                    <div class="detail-item"><strong>الحالة الضريبية:</strong><span>${format(record.TaxStatus)}</span></div>
                </div></div>
                <div class="detail-section"><h3>البيانات المالية</h3><div class="detail-grid">
                    <div class="detail-item"><strong>خصم الفاتورة (%):</strong><span>${format(record.InvoiceDiscount)}</span></div>
                    <div class="detail-item"><strong>خصم مؤجل (%):</strong><span>${format(record.DeferredDiscount)}</span></div>
                    <div class="detail-item"><strong>رسوم تكويد:</strong><span>${format(record.CodingFees)}</span></div>
                    <div class="detail-item"><strong>طريقة السداد:</strong><span>${format(record.PaymentMethod)}</span></div>
                    <div class="detail-item"><strong>فترة السداد (أيام):</strong><span>${format(record.PaymentPeriod)}</span></div>
                    <div class="detail-item"><strong>فترة رفع المرتجع (أيام):</strong><span>${format(record.ReturnPeriod)}</span></div>
                </div></div>
                <div class="detail-section"><h3>بيانات الاتصال</h3><div class="detail-grid">
                    <div class="detail-item"><strong>اسم المسؤول:</strong><span>${format(record.ContactPerson)}</span></div>
                    <div class="detail-item"><strong>المسمى الوظيفي:</strong><span>${format(record.JobTitle)}</span></div>
                    <div class="detail-item"><strong>رقم التليفون:</strong><span>${format(record.PhoneNumber)}</span></div>
                    <div class="detail-item"><strong>البريد الإلكتروني:</strong><span dir="ltr">${format(record.Email)}</span></div>
                </div></div>
                <div class="detail-section"><h3>بيانات أخرى</h3><div class="detail-grid">
                    <div class="detail-item"><strong>صاحب الطلب:</strong><span>${format(record.RequesterName)}</span></div>
                    <div class="detail-item"><strong>تاريخ الطلب:</strong><span>${format(record.RequestDate, true)}</span></div>
                    <div class="detail-item"><strong>تاريخ التسجيل:</strong><span>${format(record.RegistrationDate, true)}</span></div>
                </div></div>`;
        }

        // --- ADD/EDIT MODAL LOGIC ---
        function openFormModal(mode = 'add', recordId = null) {
            supplierModalForm.reset();
            const modalFormStatus = document.getElementById('modalFormStatus');
            modalFormStatus.style.display = 'none';
            supplierModalForm.querySelectorAll('.error-message').forEach(m => m.remove());

            document.getElementById('modalTitle').textContent = mode === 'add' ? 'إضافة مورد جديد' : 'تعديل بيانات المورد';
            modalRecordIdInput.value = recordId || '';
            modalSubmitBtn.textContent = mode === 'add' ? 'إضافة المورد' : 'حفظ التعديلات';
            
            if (mode === 'edit') {
                loadRecordForEdit(recordId);
            } else {
                toggleModal(supplierModal, true);
                document.getElementById('modalSupplierName').focus();
            }
        }

        async function loadRecordForEdit(recordId) {
            // Re-use detail fetch logic
            const url = new URL(GOOGLE_SCRIPT_URL);
            url.searchParams.append('action', 'getSupplierById');
            url.searchParams.append('id', recordId);
            try {
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success' && result.data) {
                    Object.keys(result.data).forEach(key => {
                        const input = supplierModalForm.elements[key];
                        if (input) {
                             if (input.type === 'date' && result.data[key]) input.value = result.data[key].split('T')[0];
                             else input.value = result.data[key] ?? '';
                        }
                    });
                    toggleModal(supplierModal, true);
                    document.getElementById('modalSupplierName').focus();
                } else { throw new Error(result.message); }
            } catch (error) { showStatus(error.message, 'danger'); }
        }
        
        // --- EVENT LISTENERS ---
        searchBtn.addEventListener('click', () => fetchData(searchInput.value.trim()));
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') fetchData(searchInput.value.trim()); });
        addNewSupplierBtn.addEventListener('click', () => openFormModal('add'));

        // Modal close listeners
        [supplierModal, detailModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.closest('.close-button, .modal-cancel-btn, #detailCloseBtn')) {
                    toggleModal(modal, false);
                }
            });
        });
        
        // Detail modal action listeners
        document.getElementById('detailPrintBtn').addEventListener('click', () => window.print());
        document.getElementById('detailEditBtn').addEventListener('click', () => {
            toggleModal(detailModal, false);
            openFormModal('edit', detailModal.dataset.recordId);
        });
        
        supplierModalForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            // Basic Validation
            let isValid = true;
            supplierModalForm.querySelectorAll('[required]').forEach(f => { if (!f.value.trim()) isValid = false; });
            if (!isValid) { 
                const s = document.getElementById('modalFormStatus');
                s.textContent = 'الرجاء ملء كل الحقول المطلوبة.'; s.className = 'error'; s.style.display = 'block';
                return; 
            }

            modalSubmitBtn.disabled = true;
            modalSubmitBtn.textContent = 'جاري الحفظ...';
            
            const formData = new FormData(supplierModalForm);
            formData.append('action', modalRecordIdInput.value ? 'updateSupplier' : 'createSupplier');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const result = await response.json();
                
                if (result.status === 'success') {
                    toggleModal(supplierModal, false);
                    fetchData(searchInput.value.trim()); // Refresh list
                    if (result.data && result.data.RowID) {
                        setTimeout(() => showSupplierDetails(result.data.RowID), 500);
                    }
                } else { throw new Error(result.message); }
            } catch (error) {
                const s = document.getElementById('modalFormStatus');
                s.textContent = error.message; s.className = 'error'; s.style.display = 'block';
            } finally {
                modalSubmitBtn.disabled = false;
                modalSubmitBtn.textContent = modalRecordIdInput.value ? 'حفظ التعديلات' : 'إضافة المورد';
            }
        });

        async function handleDeleteClick(recordId) {
            if (!recordId || !confirm('هل أنت متأكد أنك تريد حذف هذا المورد؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            
            const formData = new FormData();
            formData.append('action', 'deleteSupplier');
            formData.append('recordId', recordId);

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.status === 'success') fetchData(searchInput.value.trim());
                else throw new Error(result.message);
            } catch (error) { showStatus(error.message, 'danger'); }
        }

        // --- INITIALIZATION ---
        showMessage('initial', 'مرحباً بك في نظام إدارة الموردين', 'استخدم شريط البحث أعلاه للبدء، أو أضف موردًا جديدًا.');
    });
    </script>
</body>
</html>
